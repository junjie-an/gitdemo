

# **算力监测层**

## 一：核心功能

### **（一）：统一指标管理**

这是所有监测工作的基础，目标是定义和管理所有需要收集的数据。

-   **功能目标**：
1.  **建立分级指标体系**：按照国标要求，建立至少包含"算力建设投入、资源供给、服务应用、电力协同、安全保障"五个一级指标的树状结构。（对应基础设施监控、云平台监控、动环监控、业务监控）
    
2.  **指标生命周期管理**：提供对指标的增、删、改、查功能，明确每个指标的名称、定义、计算方式和数据来源。

### **（二）：多源数据采集**

这是监测层的"手和脚"，负责从各个地方把数据收集上来。

-   **功能目标**：
    1.  **对接异构资源层**：能够从管理的两种核心集群（HPC/SLURM和云原生/Kubernetes）中采集数据。
    
    2.  **支持多种采集模式**：支持**周期性采集**（如每天一次的资源总量）和**近实时采集**（如每分钟的CPU使用率）。
    
    3.  **灵活的采集方式**：支持通过**API接口调取**（主要方式）和**文件批量上报**等。
    
-   **技术方案参考**：
-   **对于Kubernetes集群**：直接采用openfuyao的 kube-prometheus-stack。
        -   **采集Agent**：使用其内置的 node-exporter（基础设施指标）和 kube-state-metrics（云平台服务指标）。
    
        -   **采集核心**：使用 Prometheus 作为统一的指标抓取、存储和查询引擎。
    
    -   **对于SLURM集群**：采用 slurm_exporter + Prometheus。
    -   部署 slurm_exporter，将SLURM的作业和节点信息转化为Prometheus格式的指标。
        
-   **对于其他数据**（如建设投入、电力数据）：可以开发**自定义的采集器**，定期调用API或将上报的文件解析后，**推送（Push）** 到Prometheus的 PushGateway 或直接写入数据库。

### **（三）：数据分析与可视化**

这是监测层的"脸面"，负责将数据变成直观的图表和报告。

-   **功能目标**：

    1.  **多维度数据统计**：支持按区域、按时间、按集群等多种维度对指标进行统计和展示。

    2.  **数据整合与对比**：能够将不同来源的数据在同一张图表中进行展示和对比（例如，对比HPC和K8s集群的CPU平均利用率）。

    3.  **异常识别与预警**：对异常数据（如资源使用率持续100%）进行识别和预警。

-   **技术方案参考**：
-   **可视化**：采用 kube-prometheus-stack 中内置的 **Grafana**。
    
    -   **优势**：Grafana天生与Prometheus无缝集成，支持强大的PromQL查询和灵活的仪表盘配置。
    
    -   **集成方式**：参考OpenScow，初期可采用 **iframe嵌入** 或 **代理模式**，将Grafana的仪表盘嵌入到您的监测平台UI中，实现单点登录和界面整合。
    
-   **告警**：使用 kube-prometheus-stack 中的 **Alertmanager**。在Prometheus中配置告警规则，当条件满足时，由Alertmanager统一负责发送告警通知（邮件、钉钉、Webhook等）。

### **（四）：数据接口与服务**

这是监测层的"对外窗口"，负责为调度层、运营层或上级平台提供数据服务。

-   **功能目标**：
    1.  **提供统一数据调取接口**：为其他层提供鉴权后的API，使其能查询原始数据或统计结果。
    
    2.  **支持数据推送**：按需向上级（区域/国家）监测平台推送数据。
    
-   **技术方案参考**：

    -   **API服务器**：在您的监测平台后端，用Java等语言开发一套 **RESTfulAPI**。
        
-   **数据来源**：
    
    -   **实时/准实时数据**：API内部通过调用 **Prometheus的HTTP
            API** 执行PromQL查询来获取。
    
    -   **历史/统计型数据**：可以从Prometheus或从其长期存储（如Thanos）中查询，也可以将汇总数据写入业务数据库（如MySQL）中供API调用。

## 二：监控信息分类

### （一）基础设施监控

**主要监控对象和数据源：**

- **计算资源：**
  - **服务器：** CPU使用率、温度、负载；内存使用率、容量；磁盘I/O（读写速度）、使用率。
  - **GPU/NPU（AI算力卡）：** 利用率、显存使用率、温度、功耗。
- **存储资源：**
  - **存储设备（SAN/NAS）：** IOPS（每秒读写次数）、带宽、延迟、存储池容量、磁盘健康状态。
- **网络资源：**
  - **网络设备（交换机、路由器）：** 端口流量（入/出）、包转发率、错包/丢包率、端口状态（Up/Down）、CPU/内存利用率。
- **虚拟化层：**
  - **Hypervisor（如VMware, KVM）：** 宿主机整体资源使用情况、虚拟机数量、虚拟交换机状态。

### （二）云平台监控

监控在基础设施之上构建的云服务的运行状态、性能和计量信息。确保出厂的产品（算力服务）是合格的。

**主要监控对象和数据源：**

- **云服务API与组件：**
  - **API网关：** 请求量、响应时间、错误率、可用性。
  - **身份认证（Keystone/IAM）：** 登录成功率、令牌发放延迟。
  - **编排服务（Heat/Terraform）：** 资源编排任务的成功/失败状态、执行时间。
- **核心云产品：**
  - **云服务器（ECS/Instance）：** 实例状态（运行/停止/异常）、vCPU/内存使用率（从Guest OS内部视角）、系统盘使用率。
  - **云数据库（RDS）：** 数据库连接数、QPS（每秒查询数）、TPS（每秒事务数）、主从延迟、缓存命中率。
  - **对象存储（OSS/S3）：** 存储桶容量、GET/PUT请求次数、网络流出流量。
- **计量与计费：**
  - **资源使用量数据：** 各个租户/项目的CPU小时、内存GB小时、存储容量、流量等消耗数据，用于计费和成本分析。

### （三）动环监控

监控为算力基础设置提供支撑的动力和环境系统。如机房温度、电压等。

**主要监控对象和数据源：**

- **动力系统：**
  - **UPS（不间断电源）：** 输入/输出电压电流、频率、电池电量、剩余后备时间、负载率。
  - **配电柜：** 开关状态、电流、电压、功率、电量。
  - **发电机：** 油位、运行状态、输出电压频率。
- **环境系统：**
  - **精密空调：** 送/回风温度湿度、压缩机状态、过滤器状态、告警信息。
  - **温湿度传感器：** 机房内各区域的实时温度和湿度。
  - **漏水检测：** 是否发生漏液及位置。
- **安防系统：**
  - **门禁系统：** 人员进出记录、门状态（开/关/超时）。
  - **视频监控：** 视频流、移动侦测告警。
  - **消防系统：** 烟雾探测器告警、灭火系统状态。

### （四）业务监控

监控为算力基础设置提供支撑的动力和环境系统。如机房温度、电压等。

### **主要监控对象和数据源**

#### **应用性能**

- **应用日志**：
  - **错误日志**：记录应用程序运行时的错误、异常堆栈和上下文信息。
  - **访问日志**：记录每个外部请求的详细信息。
  - **关键业务日志**：记录核心业务操作的过程和结果状态。
  - **技术工具**：ELK Stack (Elasticsearch, Logstash, Kibana)、Grafana Loki、Filebeat/Fluentd。
- **应用性能指标**：
  - **代码埋点指标**：在业务关键位置手动埋点采集的数据，如关键函数/方法的执行耗时、业务逻辑的成功/失败次数、特定业务事件（如“用户注册”、“订单支付”）的发生次数。
    - **技术工具**：Prometheus客户端库、OpenTelemetry SDK、Micrometer。
  - **框架与中间件指标**：由应用框架和依赖组件自动暴露的运行时指标。
    - **Web服务器**：请求率、响应时间、错误率（如Spring Boot Actuator的`/metrics`端点）。
    - **数据库客户端**：连接池使用率、查询耗时、慢查询数量。
    - **消息队列**：生产/消费速率、消息积压数（如Kafka、RabbitMQ指标）。
    - **RPC框架**：调用量、延迟、成功率（如gRPC、Dubbo指标）。
- **应用运行时指标**：
  - **JVM应用**：堆/非堆内存使用量、垃圾回收（GC）频率与耗时、线程池状态。
  - **通用资源**：进程的CPU、内存占用。

#### **用户体验**

- **真实用户监控**：
  - 从真实用户的浏览器或App端采集的性能数据，包括页面加载时间（白屏时间、首屏时间）、关键操作的交互延迟、以及JavaScript错误信息。
  - **实现方式**：在前端页面注入监控SDK（如Sentry， Datadog RUM）进行自动采集。
- **合成监控**：
  - 通过自动化脚本模拟真实用户行为（如登录、搜索、下单），定期测试关键业务流的可用性与性能。
  - **技术工具**：使用Playwright、Selenium等工具编写和运行探测脚本。

#### **业务指标**

- **核心业务数据**：
  - 直接反映业务健康与成效的指标，例如：
    - **用户增长**：日活/月活用户数、新增用户数、用户留存率。
    - **交易与营收**：订单量、订单成功率、交易总额、客单价。
    - **产品参与**：关键功能使用量、API调用次数、内容发布数量。
  - **数据来源**：主要通过**业务代码埋点**和**数据库查询分析**获得。



